<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biodiversity Dashboard</title>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.05);
            --error-color: #dc3545;
            --highlight-color: #cfe2ff;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 1.5em; color: #333; background-color: #f4f7f6; 
        }
        h1, h2 { color: #212529; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.3em; margin-top: 2em; margin-bottom: 1em; }
        h1:first-of-type, h2:first-of-type { margin-top: 0; }
        .filter-bar { padding: 1em 1.5em; background-color: #fff; border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 1.5em; display: flex; flex-wrap: wrap; gap: 1.5em; align-items: flex-start; }
        .filter-group { flex: 1 1 200px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        
        .date-filter-group { flex: 2 1 420px; min-width: 420px; }
        .date-filter-group fieldset { border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5em 1em 1em 1em; display: flex; gap: 1.5em; }
        .date-filter-group legend { font-weight: bold; font-size: 0.9em; padding: 0 0.5em; margin-left: 0.5em; color: #333; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; }
        .card { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 1.5em; position: relative; }
        .chart-card { overflow: hidden; }
        .stat-card { text-align: center; }
        .stat-card h4 { margin: 0 0 0.5em 0; color: var(--secondary-color); font-weight: normal; }
        .stat-card p { margin: 0; font-size: 2em; font-weight: bold; color: var(--primary-color); }
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 0.9em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
        th { background-color: var(--light-gray); text-align: center; }
        td.wrap-text { white-space: normal; word-break: break-word; max-width: 250px; }
        tr.highlighted { background-color: var(--highlight-color) !important; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 1em; padding: 1.5em; }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 10; font-style: italic; color: #666; }
        .error-message { text-align: center; color: var(--error-color); padding: 2em; }

        .card-header-collapsible { display: flex; justify-content: space-between; align-items: center; padding: 1em 1.5em; cursor: pointer; background-color: var(--light-gray); border-bottom: 1px solid var(--border-color); }
        .card-header-collapsible .card-title { font-weight: bold; }
        .card-content-collapsible { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0; }
        .card-content-collapsible.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; }
        
        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 0.75em 1em;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5em;
            gap: 1em;
        }
        .chart-controls .control-group {
            display: flex;
            align-items: center;
            gap: 0.75em;
        }
        .chart-controls label {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 0;
        }
        .chart-controls select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 0.9em;
        }
        .btn-group button {
            background-color: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px 15px;
            border-radius: 0;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-group button:first-child {
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }
        .btn-group button:last-child {
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            border-left-width: 0;
        }
        .btn-group button.active {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-group button:not(.active):hover {
            background-color: #e9ecef;
        }

        #map-container { height: 600px; border-radius: 8px; }
        .map-controls { padding: 0 1.5em 1.5em 1.5em; display: flex; flex-wrap: wrap; gap: 1em; align-items: center; }
        .map-controls label { font-weight: bold; }
        .map-controls select { padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); }
        .legend-container {
            background: rgba(255,255,255,0.9);
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            border-radius: 5px;
            padding: 10px;
            width: 240px;
        }
        .legend-accordion-header {
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .legend-accordion-header .arrow {
            transition: transform 0.2s ease-in-out;
        }
        .legend-accordion-header.active .arrow {
            transform: rotate(180deg);
        }
        .legend-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .legend-accordion-content.show {
            max-height: 250px; 
            overflow-y: auto;
        }
        .legend-controls {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            margin: 8px 0;
            padding-right: 5px;
        }
        .legend-controls a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            font-size: 1em;
        }
        .legend-item input { margin-right: 10px; }
        .legend-swatch {
            width: 20px; height: 20px;
            float: left; margin-right: 10px;
            border: 1px solid #777;
        }
        .leaflet-popup-content-wrapper { border-radius: 5px; }
        .leaflet-popup-content { font-size: 0.9em; }
        .leaflet-popup-content b { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Biodiversity Dashboard</h1>

    <div class="filter-bar">
        <div class="filter-group"><label for="english_name-filter">English Name</label><select id="english_name-filter" class="filter-select" multiple="multiple"></select></div>
        <div class="filter-group"><label for="species-filter">Scientific Name</label><select id="species-filter" class="filter-select" multiple="multiple"></select></div>
        <div class="filter-group"><label for="obs-filter">Observer</label><select id="obs-filter" class="filter-select" multiple="multiple"></select></div>
        <div class="filter-group"><label for="taxa-filter">Taxa</label><select id="taxa-filter" class="filter-select" multiple="multiple"></select></div>
        
        <div class="date-filter-group">
            <fieldset>
                <legend>Filter by Date</legend>
                <div class="filter-group"><label for="year-filter">Year</label><select id="year-filter" class="filter-select-single"></select></div>
                <div class="filter-group"><label for="month-filter">Month</label><select id="month-filter" class="filter-select-single"></select></div>
            </fieldset>
        </div>

        <div style="align-self: flex-end;"><button id="clear-filters" style="background-color: var(--secondary-color);">Clear Filters</button></div>
    </div>

    <h2>Dashboard Summary</h2>
    <div class="card">
        <div class="stats-grid">
            <div class="stat-card"><h4>Total Records</h4><p id="total-records">...</p></div>
            <div class="stat-card"><h4>Unique Species</h4><p id="unique-species">...</p></div>
            <div class="stat-card"><h4>Shannon Index (H')</h4><p id="shannon-index">...</p></div>
            <div class="stat-card"><h4>Gini-Simpson Index (1-D)</h4><p id="simpson-index">...</p></div>
        </div>
    </div>

    <h2>Live Map</h2>
    <div class="card" style="padding: 0;">
        <div class="map-controls">
            <label for="habitat-year-filter">Habitat Year:</label>
            <select id="habitat-year-filter">
                <option value="2024-25" selected>2024-25</option>
                <option value="2023-24">2023-24</option>
            </select>
            <label for="management-year-filter">Management Year:</label>
            <select id="management-year-filter"></select>
            <label for="cameratrap-year-filter">Camera Trap Year:</label>
            <select id="cameratrap-year-filter"></select>
        </div>
        <div id="map-container"></div>
    </div>

    <h2>Habitat Summary</h2>
    <div class="card" id="habitat-summary-container" style="padding: 0; position: relative;">
        <div class="table-wrapper" style="padding: 1.5em;">
            <table id="habitat-summary-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <h2>Annual Habitat Trends</h2>
    <div class="card" id="annual-habitat-trends-container">
        <div class="chart-controls">
            <div class="control-group">
                <label for="habitat-trend-habitat-select">Habitat:</label>
                <select id="habitat-trend-habitat-select"></select>
            </div>
            <div class="control-group">
                <label for="habitat-trend-metric-select">Metric:</label>
                <select id="habitat-trend-metric-select">
                    <option value="areaha" selected>Area (ha)</option>
                    <option value="percent_area">Area (%)</option>
                </select>
            </div>
            <div class="control-group">
                <div class="btn-group">
                    <button id="habitat-trend-absolute-btn" class="active">Absolute</button>
                    <button id="habitat-trend-standardized-btn">Standardized Growth</button>
                </div>
            </div>
        </div>
        <div id="annual-habitat-trends-chart-wrapper">
            <div id="annual-habitat-trends-chart" class="chart-card" style="height: 400px;"></div>
        </div>
        <div class="table-wrapper" style="margin-top: 2em;">
            <table id="annual-habitat-trends-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="loading-overlay" style="display: none;"><span>Loading...</span></div>
    </div>

    <h2>Annual Trends</h2>
    <div class="card" id="annual-trends-container">
        <div class="chart-controls">
            <div class="control-group">
                <label for="annual-metric-select">Metric:</label>
                <select id="annual-metric-select">
                    <option value="unique_species" selected>Unique Species</option>
                    <option value="total_records">Total Records</option>
                    <option value="shannon">Shannon Index (H')</option>
                    <option value="simpson">Gini-Simpson Index (1-D)</option>
                </select>
            </div>
            <div class="control-group">
                <div class="btn-group">
                    <button id="annual-absolute-btn" class="active">Absolute</button>
                    <button id="annual-standardized-btn">Standardized Growth</button>
                </div>
            </div>
        </div>
        <div id="annual-chart-wrapper">
            <div id="annual-trends-chart" class="chart-card" style="height: 400px;"></div>
        </div>
        <div class="table-wrapper" style="margin-top: 2em;">
            <table id="annual-trends-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Total Records</th>
                        <th>Unique Species</th>
                        <th>Shannon Index</th>
                        <th>Simpson Index</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <h2>Complete Species List</h2>
    <div class="card" style="padding: 0; position: relative;">
        <div class="card-header-collapsible" id="species-list-toggle"><span class="card-title">Toggle List View</span><span class="icon">[-]</span></div>
        <div class="card-content-collapsible">
             <div class="table-wrapper" style="padding: 1.5em;"><table id="unique-species-table"><thead><tr><th>Scientific Name</th></tr></thead><tbody></tbody></table></div>
            <div class="pagination" id="unique-species-pagination"></div>
        </div>
    </div>

    <h2>Analytics</h2>
    <div class="card chart-card" id="species-dist-container" style="position: relative;"></div>
    <div class="card chart-card" id="temporal-chart-container" style="position: relative;"></div>
    <div class="card chart-card" id="observer-chart-container" style="position: relative;"></div>

    <h2>Data Records</h2>
    <div class="card" style="padding: 0; position: relative;">
        <div class="table-wrapper" style="padding: 1.5em;"><table id="records-table"><thead><tr><th>English Name</th><th>Scientific Name</th><th>Observer</th><th>Date</th><th>Count</th><th>Taxa</th><th>Latitude</th><th>Longitude</th></tr></thead><tbody></tbody></table></div>
        <div class="pagination" id="pagination-container"></div>
    </div>

<script>
$(document).ready(function() {
    const API_BASE_URL = "https://biodiversity-dashboard.onrender.com";
    const plotlyConfig = { responsive: true, displaylogo: false };
    const monthNames = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    let isUpdatingFilters = false;
    let isInitialLoad = true;
    let annualData = [];
    let habitatSummaryData = null;
    let map, drawnItems, highlightedMarker = null;
    let geographicFilter = null;
    
    let markerLayers = {}, taxaLayerGroups = {}, taxaColors = {}, taxaVisibilityState = {};
    let habitatLayer = null; 
    let habitatLayerGroups = {}, habitatVisibilityState = {};
    let managementClusterGroup = null;
    let managementLayerGroups = {}, managementVisibilityState = {};
    let cameraTrapClusterGroup = null;
    let cameraTrapLayerGroups = {}, cameraTrapVisibilityState = {};
    let habitatBounds = null, speciesBounds = null;

    function initializeDashboard() {
        $('.filter-select').select2({ width: '100%', placeholder: 'All', allowClear: true });
        $('.filter-select-single').select2({ width: '100%', placeholder: 'All', allowClear: true });
        
        $('#clear-filters').on('click', handleClearFilters);
        $('.filter-select, .filter-select-single').on('change', handleFilterChange);
        
        $('#species-list-toggle').on('click', function() {
            const content = $(this).next('.card-content-collapsible');
            const icon = $(this).find('.icon');
            content.toggleClass('collapsed');
            icon.text(content.hasClass('collapsed') ? '[+]' : '[-]');
        });

        initializeMap();
        
        const annualTrendsContainer = $('#annual-trends-container');
        annualTrendsContainer.on('click', '#annual-absolute-btn', drawAnnualChart);
        annualTrendsContainer.on('click', '#annual-standardized-btn', drawAnnualChart);
        annualTrendsContainer.on('change', '#annual-metric-select', drawAnnualChart);

        const habitatTrendsContainer = $('#annual-habitat-trends-container');
        habitatTrendsContainer.on('change', '#habitat-trend-habitat-select', drawHabitatTrendChart);
        habitatTrendsContainer.on('change', '#habitat-trend-metric-select', drawHabitatTrendChart);
        habitatTrendsContainer.on('click', '#habitat-trend-absolute-btn', drawHabitatTrendChart);
        habitatTrendsContainer.on('click', '#habitat-trend-standardized-btn', drawHabitatTrendChart);

        $('#records-table').on('mouseenter', 'tbody tr', handleTableRowHover);
        $('#records-table').on('mouseleave', 'tbody tr', handleTableRowLeave);
        $(document).on('change', '.legend-item input[type="checkbox"]', handleLegendToggle);
        $(document).on('click', '.legend-controls a', handleLegendControls);
        $(document).on('click', '.legend-accordion-header', handleAccordionToggle);
        $('#habitat-year-filter').on('change', () => loadHabitatLayer());
        $('#management-year-filter').on('change', () => loadManagementLayer());
        $('#cameratrap-year-filter').on('change', () => loadCameraTrapLayer());

        const initialUpdatePromise = updateFilterOptions().then(updateAllDashboardComponents);
        
        updateHabitatSummary(); 
        updateAnnualTrends();
        loadUniqueSpeciesTable(1);
        initializeManagementFilter();
        initializeCameraTrapFilter();

        loadHabitatLayer().then(() => {
            $.when(initialUpdatePromise).done(checkAndFitBounds);
        });
    }

    function initializeMap() {
        map = L.map('map-container').setView([56.340, -2.796], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.createPane('habitatPane');
        map.getPane('habitatPane').style.zIndex = 390;
        map.createPane('markerPane');
        map.getPane('markerPane').style.zIndex = 400;
        map.createPane('managementPane');
        map.getPane('managementPane').style.zIndex = 410;
        map.createPane('cameraTrapPane');
        map.getPane('cameraTrapPane').style.zIndex = 420;
        
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false, polyline: false, circle: false, marker: false, circlemarker: false,
                rectangle: { shapeOptions: { color: '#007bff' } }
            },
            edit: { featureGroup: drawnItems, remove: true }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            drawnItems.addLayer(e.layer);
            const bounds = e.layer.getBounds();
            geographicFilter = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
            updateAllDashboardComponents();
        });

        map.on(L.Draw.Event.DELETED, function () {
            geographicFilter = null;
            updateAllDashboardComponents();
        });

        const legendContainer = L.control({position: 'bottomright'});
        legendContainer.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend-container');
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);
            
            div.innerHTML = `
                <div id="species-legend" class="map-legend"></div>
                <div id="habitat-legend" class="map-legend"></div>
                <div id="management-legend" class="map-legend"></div>
                <div id="cameratrap-legend" class="map-legend"></div>
            `;
            return div;
        };
        legendContainer.addTo(map);
    }

    function checkAndFitBounds() {
        if (isInitialLoad) {
            let combinedBounds = L.latLngBounds([]);
            if (habitatBounds && habitatBounds.isValid()) {
                combinedBounds.extend(habitatBounds);
            }
            if (speciesBounds && speciesBounds.isValid()) {
                combinedBounds.extend(speciesBounds);
            }

            if (combinedBounds.isValid()) {
                map.fitBounds(combinedBounds.pad(0.1));
            }
            isInitialLoad = false;
        } else {
            if ((!speciesBounds || !speciesBounds.isValid()) && (habitatBounds && habitatBounds.isValid())) {
                map.fitBounds(habitatBounds.pad(0.1));
            }
        }
    }

    function initializeManagementFilter() {
        $.get(`${API_BASE_URL}/api/management_years`).done(years => {
            const filter = $('#management-year-filter');
            filter.empty();
            if (years && years.length > 0) {
                years.forEach(year => {
                    filter.append(new Option(year, year));
                });
                filter.trigger('change');
            } else {
                filter.append(new Option('No Data', ''));
            }
        });
    }

    function initializeCameraTrapFilter() {
        $.get(`${API_BASE_URL}/api/cameratrap_years`).done(years => {
            const filter = $('#cameratrap-year-filter');
            filter.empty();
            if (years && years.length > 0) {
                years.forEach(year => {
                    filter.append(new Option(year, year));
                });
                filter.trigger('change');
            } else {
                filter.append(new Option('No Data', ''));
            }
        });
    }

    function getManagementStyle(type) {
        let color;
        switch (type) {
            case 'box': color = '#8B4513'; break;
            case 'feeder': color = '#DC143C'; break;
            case 'hedge': color = '#228B22'; break;
            case 'meadow': color = '#FFD700'; break;
            case 'woodland': color = '#556B2F'; break;
            default: color = '#808080';
        }
        return color;
    }

    function createDiamondIcon(color) {
        const svg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
            <path d="M12 0 L24 12 L12 24 L0 12 Z" fill="${color}" stroke="black" stroke-width="1.5"/>
        </svg>`;
        return L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(svg),
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, -8]
        });
    }

    function getCameraTrapStyle(month) {
        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#aec7e8', '#ffbb78'];
        return colors[parseInt(month - 1) % colors.length];
    }

    function createTriangleIcon(color) {
        const svg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
            <path d="M12 0 L24 24 L0 24 Z" fill="${color}" stroke="black" stroke-width="1.5"/>
        </svg>`;
        return L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(svg),
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, -8]
        });
    }

    function loadManagementLayer() {
        const selectedYear = $('#management-year-filter').val();
        if (!selectedYear) return;

        if (managementClusterGroup) {
            map.removeLayer(managementClusterGroup);
        }
        managementClusterGroup = L.markerClusterGroup({ pane: 'managementPane' });

        return $.get(`${API_BASE_URL}/api/management_points`, { year: selectedYear }).done(data => {
            if (!data || !data.features) {
                $('#management-legend').hide();
                return;
            }

            const types = [...new Set(data.features.map(f => f.properties['type2'] || "Unknown"))].sort();
            managementLayerGroups = {};
            types.forEach(name => {
                managementLayerGroups[name] = L.layerGroup();
                if (managementVisibilityState[name] === undefined) {
                    managementVisibilityState[name] = true;
                }
            });

            L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    const type = feature.properties['type2'] || "Unknown";
                    const color = getManagementStyle(type);
                    return L.marker(latlng, { 
                        icon: createDiamondIcon(color)
                    });
                },
                onEachFeature: function(feature, layer) {
                    const type = feature.properties['type2'] || "Unknown";
                    const management = feature.properties['management'] || "N/A";
                    layer.bindPopup(`<b>Type:</b> ${type}<br><b>Management:</b> ${management}`);
                    if (managementLayerGroups[type]) {
                        managementLayerGroups[type].addLayer(layer);
                    }
                }
            });

            types.forEach(type => {
                if (managementVisibilityState[type]) {
                    managementClusterGroup.addLayer(managementLayerGroups[type]);
                }
            });
            
            map.addLayer(managementClusterGroup);
            updateManagementLegend(types);
        }).fail(() => {
            console.error("Could not load management points for year: " + selectedYear);
            $('#management-legend').hide();
        });
    }

    function updateManagementLegend(types) {
        let legendContent = `
            <div class="legend-accordion-header" data-target="#management-content">
                <span>Management</span><span class="arrow">▼</span>
            </div>
            <div class="legend-accordion-content" id="management-content">
                <div class="legend-controls">
                    <a data-type="management" data-action="all">Select All</a>
                    <a data-type="management" data-action="none">Deselect All</a>
                </div>
                <div class="legend-scroll-content">`;
        
        types.forEach(name => {
            const isChecked = managementVisibilityState[name] ? 'checked' : '';
            const color = getManagementStyle(name);
            const swatchHtml = `<i class="legend-swatch" style="background-image: url('data:image/svg+xml;base64,${btoa(`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0 L24 12 L12 24 L0 12 Z" fill="${color}" stroke="black" stroke-width="1"/></svg>`)}'); background-size: contain;"></i>`;

            legendContent += `<div class="legend-item">
                <label>
                    <input type="checkbox" data-type="management" data-name="${name}" ${isChecked}>
                    ${swatchHtml}
                    <span>${name}</span>
                </label>
            </div>`;
        });
        legendContent += `</div></div>`;
        $('#management-legend').html(legendContent).show();
    }

    function loadCameraTrapLayer() {
        const selectedYear = $('#cameratrap-year-filter').val();
        if (!selectedYear) return;

        if (cameraTrapClusterGroup) {
            map.removeLayer(cameraTrapClusterGroup);
        }
        cameraTrapClusterGroup = L.markerClusterGroup({ pane: 'cameraTrapPane' });

        return $.get(`${API_BASE_URL}/api/cameratrap_points`, { year: selectedYear }).done(data => {
            if (!data || !data.features) {
                $('#cameratrap-legend').hide();
                return;
            }

            const months = [...new Set(data.features.map(f => f.properties['monthout'] || "Unknown"))].sort((a, b) => a - b);
            cameraTrapLayerGroups = {};
            months.forEach(name => {
                cameraTrapLayerGroups[name] = L.layerGroup();
                if (cameraTrapVisibilityState[name] === undefined) {
                    cameraTrapVisibilityState[name] = true;
                }
            });

            L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    const month = feature.properties['monthout'] || "Unknown";
                    const color = getCameraTrapStyle(month);
                    return L.marker(latlng, { 
                        icon: createTriangleIcon(color)
                    });
                },
                onEachFeature: function(feature, layer) {
                    const month = feature.properties['monthout'] || "Unknown";
                    const trapNumber = feature.properties['ctrapnumber'] || "N/A";
                    layer.bindPopup(`<b>Trap Number:</b> ${trapNumber}<br><b>Month Out:</b> ${monthNames[month] || month}`);
                    if (cameraTrapLayerGroups[month]) {
                        cameraTrapLayerGroups[month].addLayer(layer);
                    }
                }
            });

            months.forEach(month => {
                if (cameraTrapVisibilityState[month]) {
                    cameraTrapClusterGroup.addLayer(cameraTrapLayerGroups[month]);
                }
            });
            
            map.addLayer(cameraTrapClusterGroup);
            updateCameraTrapLegend(months);
        }).fail(() => {
            console.error("Could not load camera trap points for year: " + selectedYear);
            $('#cameratrap-legend').hide();
        });
    }

    function updateCameraTrapLegend(months) {
        let legendContent = `
            <div class="legend-accordion-header" data-target="#cameratrap-content">
                <span>Camera Traps</span><span class="arrow">▼</span>
            </div>
            <div class="legend-accordion-content" id="cameratrap-content">
                <div class="legend-controls">
                    <a data-type="cameratrap" data-action="all">Select All</a>
                    <a data-type="cameratrap" data-action="none">Deselect All</a>
                </div>
                <div class="legend-scroll-content">`;
        
        months.forEach(month => {
            const isChecked = cameraTrapVisibilityState[month] ? 'checked' : '';
            const color = getCameraTrapStyle(month);
            const swatchHtml = `<i class="legend-swatch" style="background-image: url('data:image/svg+xml;base64,${btoa(`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0 L24 24 L0 24 Z" fill="${color}" stroke="black" stroke-width="1"/></svg>`)}'); background-size: contain;"></i>`;

            legendContent += `<div class="legend-item">
                <label>
                    <input type="checkbox" data-type="cameratrap" data-name="${month}" ${isChecked}>
                    ${swatchHtml}
                    <span>Month: ${monthNames[month] || month}</span>
                </label>
            </div>`;
        });
        legendContent += `</div></div>`;
        $('#cameratrap-legend').html(legendContent).show();
    }

    function loadHabitatLayer() {
        const selectedYear = $('#habitat-year-filter').val();
        if (habitatLayer) {
            map.removeLayer(habitatLayer);
            habitatLayer = null;
        }
        
        return $.get(`${API_BASE_URL}/api/habitat_polygons`, { year: selectedYear }).done(data => {
            if (!data || !data.features) {
                $('#habitat-legend').hide();
                return;
            }

            const classifications = [...new Set(data.features.map(f => f.properties['broad'] || "Unknown"))].sort();
            habitatLayerGroups = {};
            classifications.forEach(name => {
                habitatLayerGroups[name] = L.layerGroup();
                if (habitatVisibilityState[name] === undefined) {
                    habitatVisibilityState[name] = true;
                }
            });

            habitatLayer = L.geoJSON(data, {
                onEachFeature: function(feature, layer) {
                    const classification = feature.properties['broad'] || "Unknown";
                    if (habitatLayerGroups[classification]) {
                        layer.bindPopup(`<b>Habitat:</b> ${classification}<br><b>Year:</b> ${feature.properties['year'] || 'N/A'}`);
                        habitatLayerGroups[classification].addLayer(layer);
                    }
                    layer.on({
                        mouseover: (e) => e.target.setStyle({ weight: 3, color: '#FFFF00' }),
                        mouseout: (e) => habitatLayer.resetStyle(e.target)
                    });
                },
                style: styleHabitat
            });

            habitatLayer.addTo(map);
            
            habitatBounds = habitatLayer.getBounds();
            updateHabitatLegend(classifications);
            checkAndFitBounds();
            
        }).fail(() => {
            console.error("Could not load habitat polygons for year: " + selectedYear);
            $('#habitat-legend').hide();
        });
    }

    function styleHabitat(feature) {
        const classification = feature.properties['broad'] || "Unknown";
        let style = {
            weight: 1.5,
            opacity: 0.8,
            fillOpacity: 0.7,
            pane: 'habitatPane'
        };

        switch (classification) {
            case 'arable margins': style.fillColor = '#FFA500'; break;
            case 'buildings': style.fillColor = '#696969'; break;
            case 'freshwater': style.fillColor = '#ADD8E6'; break;
            case 'garden': style.fillColor = '#9ACD32'; break;
            case 'hedge': style.fillColor = '#6B8E23'; break;
            case 'intertidal mudflat': style.fillColor = '#D2B48C'; break;
            case 'modified grassland': style.fillColor = '#00FF00'; break;
            case 'natural grassland': style.fillColor = '#ADFF2F'; break;
            case 'other developed land': style.fillColor = '#778899'; break;
            case '(unsealed unvegetated surface)': style.fillColor = '#800080'; break;
            case 'woodland': style.fillColor = '#228B22'; break;
            default: style.fillColor = '#000000';
        }
        style.color = style.fillColor;
        return style;
    }

    function updateHabitatLegend(classifications) {
        let legendContent = `
            <div class="legend-accordion-header" data-target="#habitat-content">
                <span>Habitats</span><span class="arrow">▼</span>
            </div>
            <div class="legend-accordion-content" id="habitat-content">
                <div class="legend-controls">
                    <a data-type="habitat" data-action="all">Select All</a>
                    <a data-type="habitat" data-action="none">Deselect All</a>
                </div>
                <div class="legend-scroll-content">`;
        
        classifications.forEach(name => {
            const isChecked = habitatVisibilityState[name] ? 'checked' : '';
            const style = styleHabitat({ properties: { broad: name } });
            const swatchHtml = `<i class="legend-swatch" style="background: ${style.fillColor};"></i>`;

            legendContent += `<div class="legend-item">
                <label>
                    <input type="checkbox" data-type="habitat" data-name="${name}" ${isChecked}>
                    ${swatchHtml}
                    <span>${name}</span>
                </label>
            </div>`;
        });
        legendContent += `</div></div>`;
        $('#habitat-legend').html(legendContent).show();
    }


    function handleAccordionToggle(event) {
        const header = $(event.currentTarget);
        const content = header.next('.legend-accordion-content');
        const wasActive = header.hasClass('active');

        $('.legend-accordion-header').removeClass('active');
        $('.legend-accordion-content').removeClass('show');

        if (!wasActive) {
            header.addClass('active');
            content.addClass('show');
        }
    }

    function handleLegendControls(event) {
        const type = $(event.target).data('type');
        const action = $(event.target).data('action');
        const shouldBeChecked = action === 'all';
        
        $(`.legend-item input[data-type="${type}"]`).prop('checked', shouldBeChecked).trigger('change');
    }

    function handleLegendToggle(event) {
        const type = $(event.target).data('type');
        const name = $(event.target).data('name');
        const isChecked = event.target.checked;

        if (type === 'species') {
            taxaVisibilityState[name] = isChecked;
            const layerGroup = taxaLayerGroups[name];
            if (layerGroup) {
                if (isChecked) markerLayers.clusterGroup.addLayer(layerGroup);
                else markerLayers.clusterGroup.removeLayer(layerGroup);
            }
        } else if (type === 'habitat') {
            habitatVisibilityState[name] = isChecked;
            const layerGroup = habitatLayerGroups[name];
            if (layerGroup) {
                if (isChecked) habitatLayer.addLayer(layerGroup);
                else habitatLayer.removeLayer(layerGroup);
            }
        } else if (type === 'management') {
            managementVisibilityState[name] = isChecked;
            const layerGroup = managementLayerGroups[name];
            if (layerGroup && managementClusterGroup) {
                if (isChecked) managementClusterGroup.addLayer(layerGroup);
                else managementClusterGroup.removeLayer(layerGroup);
            }
        } else if (type === 'cameratrap') {
            cameraTrapVisibilityState[name] = isChecked;
            const layerGroup = cameraTrapLayerGroups[name];
            if (layerGroup && cameraTrapClusterGroup) {
                if (isChecked) cameraTrapClusterGroup.addLayer(layerGroup);
                else cameraTrapClusterGroup.removeLayer(layerGroup);
            }
        }
    }

    function updateMap(filters) {
        if (markerLayers.clusterGroup) {
            map.removeLayer(markerLayers.clusterGroup);
        }
        markerLayers = { individual: {}, clusterGroup: L.markerClusterGroup({ pane: 'markerPane' }) };
        taxaLayerGroups = {};

        return $.get(`${API_BASE_URL}/api/map_data`, filters).done(data => {
            const speciesLegendDiv = $('#species-legend');
            if (!data || data.length === 0) {
                speciesLegendDiv.html(`
                    <div class="legend-accordion-header active" data-target="#species-content">
                        <span>Species</span><span class="arrow">▼</span>
                    </div>
                    <div class="legend-accordion-content show" id="species-content">No species data for this selection.</div>`);
                speciesBounds = null;
                checkAndFitBounds();
                return;
            }

            const uniqueTaxa = [...new Set(data.map(item => item.taxa || 'Unknown'))].sort();
            
            uniqueTaxa.forEach(taxa => {
                taxaLayerGroups[taxa] = L.layerGroup();
                if (taxaVisibilityState[taxa] === undefined) {
                    taxaVisibilityState[taxa] = true;
                }
            });

            taxaColors = uniqueTaxa.reduce((acc, taxa) => {
                acc[taxa] = stringToColor(taxa);
                return acc;
            }, {});

            data.forEach(point => {
                const taxa = point.taxa || 'Unknown';
                const marker = L.circleMarker([point.latitude, point.longitude], {
                    radius: 8, fillColor: taxaColors[taxa], color: "#000",
                    weight: 1, opacity: 1, fillOpacity: 0.8, pane: 'markerPane'
                });

                const popupContent = `<b>${point.english_name || 'N/A'}</b><br><i>${point.species || 'N/A'}</i><br><hr><b>Observer:</b> ${point.obs || 'N/A'}<br><b>Date:</b> ${point.Date ? new Date(point.Date).toLocaleDateString() : 'N/A'}<br><b>Taxa:</b> ${taxa}`;
                marker.bindPopup(popupContent);
                marker.on('click', () => handleMapMarkerClick(point.id));
                
                taxaLayerGroups[taxa].addLayer(marker);
                markerLayers.individual[point.id] = marker;
            });

            uniqueTaxa.forEach(taxa => {
                if (taxaVisibilityState[taxa]) {
                    markerLayers.clusterGroup.addLayer(taxaLayerGroups[taxa]);
                }
            });

            map.addLayer(markerLayers.clusterGroup);
            speciesBounds = markerLayers.clusterGroup.getBounds();
            checkAndFitBounds();

            let legendContent = `
                <div class="legend-accordion-header active" data-target="#species-content">
                    <span>Species</span><span class="arrow">▼</span>
                </div>
                <div class="legend-accordion-content show" id="species-content">
                    <div class="legend-controls">
                        <a data-type="species" data-action="all">Select All</a>
                        <a data-type="species" data-action="none">Deselect All</a>
                    </div>
                    <div class="legend-scroll-content">`;
            uniqueTaxa.forEach(taxa => {
                const isChecked = taxaVisibilityState[taxa] ? 'checked' : '';
                legendContent += `<div class="legend-item">
                    <label>
                        <input type="checkbox" data-type="species" data-name="${taxa}" ${isChecked}>
                        <i class="legend-swatch" style="background:${taxaColors[taxa]}; border-radius: 50%;"></i>
                        <span>${taxa}</span>
                    </label>
                </div>`;
            });
            legendContent += '</div></div>';
            speciesLegendDiv.html(legendContent);
        });
    }

    function handleClearFilters() {
        if (isUpdatingFilters) return;
        isInitialLoad = true;
        geographicFilter = null;
        drawnItems.clearLayers();
        taxaVisibilityState = {};
        habitatVisibilityState = {};
        $('.legend-item input[type="checkbox"]').prop('checked', true);
        Object.values(habitatLayerGroups).forEach(lg => { if (lg && !habitatLayer.hasLayer(lg)) habitatLayer.addLayer(lg); });
        $('.filter-select, .filter-select-single').val(null).trigger('change');
    }

    function handleFilterChange() {
        if (isUpdatingFilters) return;
        isInitialLoad = false;
        updateFilterOptions().then(updateAllDashboardComponents);
    }

    function updateFilterOptions() {
        isUpdatingFilters = true;
        const currentFilters = getActiveFilters();
        return $.get(`${API_BASE_URL}/api/filter-options`, currentFilters).done(data => {
            $('.filter-select, .filter-select-single').each(function() {
                const selector = $(this);
                const key = selector.attr('id').replace('-filter', '');
                const selectedValue = selector.val();
                selector.empty();
                if (selector.hasClass('filter-select-single')) {
                    selector.append(new Option('All', '', false, false));
                }
                if (data[key]) {
                    data[key].forEach(val => {
                        const text = key === 'month' ? monthNames[val] : val;
                        selector.append(new Option(text, val));
                    });
                }
                selector.val(selectedValue);
            });
            $('.filter-select, .filter-select-single').trigger('change.select2');
        }).fail(() => {
            console.error("Failed to update filter options.");
            alert("Error: Could not contact the server to update filters.");
        }).always(() => {
            isUpdatingFilters = false;
        });
    }

    function getActiveFilters() {
        const filters = {};
        $('.filter-select, .filter-select-single').each(function() {
            const id = $(this).attr('id').replace('-filter', '');
            let val = $(this).val();
            if (val && Array.isArray(val) && val.length > 0) filters[id] = val.join(',');
            else if (val && !Array.isArray(val) && val !== '') filters[id] = val;
        });
        if (geographicFilter) {
            filters.bbox = geographicFilter;
        }
        return filters;
    }

    function updateAllDashboardComponents() {
        const filters = getActiveFilters();
        setLoadingState(true);
        const requests = [
            loadTable(filters, 1),
            updateSummaryStats(filters),
            updateMap(filters),
            updateSpeciesDistributionChart(filters),
            updateObserverChart(filters),
            updateTemporalChart(filters)
        ];
        return $.when(...requests).always(() => setLoadingState(false));
    }

    function setLoadingState(isLoading) {
        $('.error-message').remove();
        const mainCards = $('.card:visible').not('#unique-species-table .card, #annual-trends-container, #habitat-summary-container, #annual-habitat-trends-container'); 
        if (isLoading) {
            mainCards.append('<div class="loading-overlay"><span>Loading...</span></div>');
        } else {
            $('.loading-overlay').remove();
        }
    }

    function showErrorMessage(containerSelector, message) {
        $(containerSelector).html(`<div class="error-message">${message}</div>`);
    }

    function loadTable(filters, page = 1, recordToHighlight = null) {
        return $.get(`${API_BASE_URL}/api/records`, { ...filters, page: page }).done(data => {
            $('#total-records').text(data.total_records.toLocaleString());
            const tableBody = $('#records-table tbody').empty();
            if (!data.records || data.records.length === 0) {
                tableBody.append('<tr><td colspan="8" style="text-align:center; padding: 2em;">No records found.</td></tr>');
            } else {
                data.records.forEach(row => {
                    const formattedDate = row.Date ? new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(new Date(row.Date)) : '';
                    const tableRow = `<tr data-record-id="${row.id}"><td class="wrap-text" title="${row.english_name || ''}">${row.english_name || ''}</td><td>${row.species || ''}</td><td>${row.obs || ''}</td><td>${formattedDate}</td><td>${row.count || ''}</td><td>${row.taxa || ''}</td><td>${row.latitude || ''}</td><td>${row.longitude || ''}</td></tr>`;
                    tableBody.append(tableRow);
                });
            }
            updatePagination(data.total_pages, data.page, filters);

            if (recordToHighlight) {
                const row = $(`#records-table tr[data-record-id="${recordToHighlight}"]`);
                if (row.length) {
                    $('#records-table tr').removeClass('highlighted');
                    row.addClass('highlighted');
                    row[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }).fail(() => {
            showErrorMessage('#records-table tbody', 'Could not load records from server.');
            $('#total-records').text('Error');
        });
    }

    function handleTableRowHover(event) {
        const recordId = $(event.currentTarget).data('record-id');
        const marker = markerLayers.individual[recordId];
        if (marker) {
            highlightedMarker = marker;
            marker.setRadius(12);
            marker.setStyle({ weight: 3, color: '#ff0000' });
            marker.bringToFront();
        }
    }

    function handleTableRowLeave() {
        if (highlightedMarker) {
            highlightedMarker.setRadius(8);
            highlightedMarker.setStyle({ weight: 1, color: '#000' });
            highlightedMarker = null;
        }
    }

    function handleMapMarkerClick(recordId) {
        const filters = getActiveFilters();
        $.get(`${API_BASE_URL}/api/record_page`, { ...filters, record_id: recordId })
            .done(data => {
                if (data.page) {
                    loadTable(filters, data.page, recordId);
                }
            })
            .fail(() => alert('Could not find the corresponding record in the table.'));
    }

    function updatePagination(totalPages, page, filters) {
        const container = $('#pagination-container').empty();
        if (totalPages <= 1) return;

        const firstButton = $('<button>First</button>').on('click', () => loadTable(filters, 1)).prop('disabled', page === 1);
        const prevButton = $('<button>« Previous</button>').on('click', () => loadTable(filters, page - 1)).prop('disabled', page === 1);
        const nextButton = $('<button>Next »</button>').on('click', () => loadTable(filters, page + 1)).prop('disabled', page === totalPages);
        const lastButton = $('<button>Last</button>').on('click', () => loadTable(filters, totalPages)).prop('disabled', page === totalPages);

        container.append(firstButton, prevButton, `<span> Page ${page} of ${totalPages} </span>`, nextButton, lastButton);
    }

    function updateSummaryStats(filters) {
        return $.get(`${API_BASE_URL}/api/summary/diversity`, filters).done(data => {
            $('#unique-species').text(data.species_richness);
            $('#shannon-index').text(data.shannon);
            $('#simpson-index').text(data.simpson);
        }).fail(() => $('#unique-species, #shannon-index, #simpson-index').text('Error'));
    }

    function updateHabitatSummary() {
        const container = $('#habitat-summary-container');
        container.append('<div class="loading-overlay"><span>Loading...</span></div>');

        $.get(`${API_BASE_URL}/api/summary/habitat`).done(data => {
            const table = $('#habitat-summary-table');
            const thead = table.find('thead').empty();
            const tbody = table.find('tbody').empty();

            if (!data || !data.years || data.years.length === 0) {
                showErrorMessage('#habitat-summary-table', 'No habitat summary data available.');
                return;
            }

            const headerRow1 = $('<tr>');
            headerRow1.append('<th rowspan="2" style="vertical-align: middle;">Habitat</th>');
            
            const headerRow2 = $('<tr>');
            const metricHeaders = ['Area (ha)', 'Area (%)', 'Biomscore', 'No. 10m Squares', 'Squares (%)'];

            data.years.forEach(year => {
                headerRow1.append(`<th colspan="5">${year}</th>`);
                metricHeaders.forEach(metric => {
                    headerRow2.append(`<th>${metric}</th>`);
                });
            });
            thead.append(headerRow1, headerRow2);

            data.habitats.forEach(habitat => {
                const row = $('<tr>');
                row.append(`<td><b>${habitat.name}</b></td>`);
                data.years.forEach(year => {
                    const metrics = habitat.metrics[year];
                    if (metrics) {
                        row.append(`<td style="text-align:right;">${metrics.areaha.toFixed(1)}</td>`);
                        row.append(`<td style="text-align:right;">${metrics.percent_area.toFixed(1)}%</td>`);
                        row.append(`<td style="text-align:right;">${Math.round(metrics.biomscore).toLocaleString()}</td>`);
                        row.append(`<td style="text-align:right;">${metrics.no10msquares.toLocaleString()}</td>`);
                        row.append(`<td style="text-align:right;">${metrics.percent_squares.toFixed(1)}%</td>`);
                    } else {
                        row.append('<td colspan="5">N/A</td>');
                    }
                });
                tbody.append(row);
            });

            const totalRow = $('<tr style="font-weight: bold; background-color: var(--light-gray);">');
            totalRow.append('<td>Total</td>');
            data.years.forEach(year => {
                const totals = data.totals[year];
                if (totals) {
                    totalRow.append(`<td style="text-align:right;">${totals.areaha.toFixed(1)}</td>`);
                    totalRow.append(`<td style="text-align:right;">${totals.percent_area.toFixed(1)}%</td>`);
                    totalRow.append(`<td style="text-align:right;">${Math.round(totals.biomscore).toLocaleString()}</td>`);
                    totalRow.append(`<td style="text-align:right;">${totals.no10msquares.toLocaleString()}</td>`);
                    totalRow.append(`<td style="text-align:right;">${totals.percent_squares.toFixed(1)}%</td>`);
                } else {
                    totalRow.append('<td colspan="5">N/A</td>');
                }
            });
            tbody.append(totalRow);

            habitatSummaryData = data;
            initializeHabitatTrends();

        }).fail(() => {
            showErrorMessage('#habitat-summary-container', 'Could not load habitat summary data from the server.');
            $('#annual-habitat-trends-container').hide();
        }).always(() => {
            container.find('.loading-overlay').remove();
        });
    }

    function initializeHabitatTrends() {
        if (!habitatSummaryData || !habitatSummaryData.habitats) {
            $('#annual-habitat-trends-container').hide();
            return;
        }
        $('#annual-habitat-trends-container').show();

        const habitatSelect = $('#habitat-trend-habitat-select');
        habitatSelect.empty();

        habitatSelect.append(new Option('Total', 'Total'));

        habitatSummaryData.habitats.forEach(habitat => {
            habitatSelect.append(new Option(habitat.name, habitat.name));
        });

        habitatSelect.val('Total');
        $('#habitat-trend-metric-select').val('areaha');

        drawHabitatTrendChart();
    }

    function drawHabitatTrendChart(event) {
        if (!habitatSummaryData) return;

        if (event && $(event.currentTarget).is('button')) {
            $('#annual-habitat-trends-container .btn-group button').removeClass('active');
            $(event.currentTarget).addClass('active');
        }

        const selectedHabitat = $('#habitat-trend-habitat-select').val();
        const selectedMetric = $('#habitat-trend-metric-select').val();
        const selectedMetricText = $('#habitat-trend-metric-select option:selected').text();
        const mode = $('#habitat-trend-standardized-btn').hasClass('active') ? 'standardized' : 'absolute';
        const years = habitatSummaryData.years;

        let sourceData;
        if (selectedHabitat === 'Total') {
            sourceData = habitatSummaryData.totals;
        } else {
            sourceData = habitatSummaryData.habitats.find(h => h.name === selectedHabitat)?.metrics;
        }

        if (!sourceData) {
            showErrorMessage('#annual-habitat-trends-chart', 'Could not find data for the selected habitat.');
            return;
        }

        const chartRawValues = years.map(year => sourceData[year] ? sourceData[year][selectedMetric] : 0);
        const tableAreaHaValues = years.map(year => sourceData[year] ? sourceData[year]['areaha'] : 0);
        const tableAreaPercentValues = years.map(year => sourceData[year] ? sourceData[year]['percent_area'] : 0);

        let chartValues;
        let layout;

        if (mode === 'absolute') {
            chartValues = chartRawValues;
            layout = {
                title: { text: `<b>${selectedHabitat} - ${selectedMetricText} (Absolute)</b>`, font: { size: 18 } },
                yaxis: { title: selectedMetricText },
                xaxis: { type: 'category', title: 'Year' },
                margin: { t: 50, b: 40, l: 60, r: 20 }
            };
        } else {
            const baseValue = chartRawValues[0];
            chartValues = baseValue > 0 ? chartRawValues.map(d => (d / baseValue) * 100) : chartRawValues.map(() => 0);
            layout = {
                title: { text: `<b>${selectedHabitat} - ${selectedMetricText} Growth (First Year = 100)</b>`, font: { size: 18 } },
                yaxis: { title: 'Growth Index', ticksuffix: '%' },
                xaxis: { type: 'category', title: 'Year' },
                margin: { t: 50, b: 40, l: 60, r: 20 }
            };
        }

        const trace = [{ 
            x: years, 
            y: chartValues, 
            type: 'bar',
            hovertemplate: '<b>Year: %{x}</b><br>Value: %{y:.2f}<extra></extra>'
        }];
        Plotly.newPlot('annual-habitat-trends-chart', trace, plotlyConfig);

        updateHabitatTrendTable(years, tableAreaHaValues, tableAreaPercentValues);
    }

    function updateHabitatTrendTable(years, areaHaValues, areaPercentValues) {
        const table = $('#annual-habitat-trends-table');
        const thead = table.find('thead').empty();
        const tbody = table.find('tbody').empty();

        thead.append(`<tr><th>Year</th><th>Area (ha)</th><th>Area (%)</th></tr>`);

        years.forEach((year, index) => {
            const areaHa = areaHaValues[index];
            const areaPercent = areaPercentValues[index];
            
            const formattedAreaHa = Number.isInteger(areaHa) ? areaHa.toLocaleString() : areaHa.toFixed(2);
            const formattedAreaPercent = Number.isInteger(areaPercent) ? areaPercent.toLocaleString() : areaPercent.toFixed(2);

            tbody.append(`<tr>
                <td><b>${year}</b></td>
                <td style="text-align:right;">${formattedAreaHa}</td>
                <td style="text-align:right;">${formattedAreaPercent}%</td>
            </tr>`);
        });
    }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + value.toString(16)).substr(-2);
        }
        return color;
    }

    function updateSpeciesDistributionChart(filters) {
        const container = $('#species-dist-container');
        return $.get(`${API_BASE_URL}/api/summary/species_distribution`, filters).done(data => {
            if (!data || data.length === 0) { container.closest('.card').hide(); return; }
            container.closest('.card').show();
            container.empty();
            const sortedData = data.slice().reverse(); 
            const speciesNames = sortedData.map(d => d.name);
            const chartHeight = 150 + (speciesNames.length * 35);
            container.height(chartHeight);
            const dataByTaxa = {};
            sortedData.forEach(d => {
                if (!dataByTaxa[d.taxa]) dataByTaxa[d.taxa] = [];
                dataByTaxa[d.taxa].push(d);
            });
            const traces = Object.keys(dataByTaxa).map(taxaName => {
                const x_values = speciesNames.map(name => {
                    const found = dataByTaxa[taxaName].find(d => d.name === name);
                    return found ? found.count : null;
                });
                return { name: taxaName, type: 'bar', orientation: 'h', y: speciesNames, x: x_values, hovertemplate: '%{y}: %{x}<extra></extra>' };
            });
            const layout = {
                title: { text: '<b>Top 20 Species by Observation Records</b>', font: { size: 20 } },
                barmode: 'stack', height: chartHeight,
                margin: { t: 100, b: 80, l: 240, r: 50 },
                yaxis: { automargin: true, tickfont: { size: 14 } },
                xaxis: { title: { text: 'Number of Records', font: { size: 16 } } },
                legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 }
            };
            Plotly.newPlot('species-dist-container', traces, layout, plotlyConfig);
        }).fail(() => showErrorMessage('#species-dist-container', 'Could not load Species Distribution chart.'));
    }

    function updateTemporalChart(filters) {
        const container = $('#temporal-chart-container');
        container.height(500); 
        return $.get(`${API_BASE_URL}/api/summary/temporal_trends`, filters).done(data => {
            if (Object.keys(data).length === 0) { container.closest('.card').hide(); return; }
            container.closest('.card').show();
            container.empty();
            const trace = [{ x: Object.keys(data).map(m => monthNames[parseInt(m)]), y: Object.values(data), type: 'bar' }];
            const layout = { title: 'Observations by Month', yaxis: {title: 'Number of Records'}, margin: { t: 50, b: 40, l: 60, r: 20 } };
            Plotly.newPlot('temporal-chart-container', trace, layout, plotlyConfig);
        }).fail(() => showErrorMessage('#temporal-chart-container', 'Could not load Temporal Trends chart.'));
    }

    function updateObserverChart(filters) {
        const container = $('#observer-chart-container');
        const observers = filters.obs ? filters.obs.split(',') : [];
        if (observers.length === 0) { container.closest('.card').hide(); return $.when(); }
        container.closest('.card').show();
        container.empty();
        container.height(500);

        if (observers.length === 1) {
            const observerName = observers[0];
            const { obs, ...otherFilters } = filters;
            return $.get(`${API_BASE_URL}/api/summary/observer/${encodeURIComponent(observerName)}`, otherFilters)
                .done(data => {
                    if (!data || !data.specialization || Object.keys(data.specialization).length === 0) { container.closest('.card').hide(); return; }
                    const chartData = data.specialization;
                    const otherBreakdown = data.other_breakdown || {};
                    const labels = Object.keys(chartData);
                    const values = Object.values(chartData);
                    const total = values.reduce((sum, val) => sum + val, 0);
                    const hoverTexts = labels.map((label, i) => {
                        const value = values[i];
                        const percent = ((value / total) * 100).toFixed(2);
                        let hoverText = `<b>${label}</b><br>Count: ${value}<br>${percent}%`;
                        if (label === 'Other' && Object.keys(otherBreakdown).length > 0) {
                            hoverText += '<br><hr><i>Including:</i>';
                            for (const [key, val] of Object.entries(otherBreakdown)) hoverText += `<br>- ${key}: ${val}`;
                        }
                        return hoverText;
                    });
                    const trace = [{ type: 'pie', labels: labels, values: values, hole: .4, hoverinfo: 'text', text: hoverTexts, textinfo: 'none', automargin: true }];
                    const layout = { title: `Taxonomic Specialization for ${observerName}`, showlegend: true, margin: { t: 50, b: 20, l: 20, r: 20 } };
                    Plotly.newPlot('observer-chart-container', trace, layout, plotlyConfig);
                }).fail(() => showErrorMessage('#observer-chart-container', 'Could not load Observer chart.'));
        } else {
            return $.get(`${API_BASE_URL}/api/summary/observer_comparison`, filters)
                .done(data => {
                    if (!data || Object.keys(data).length === 0) { container.closest('.card').hide(); return; }
                    const taxaNames = Object.keys(data);
                    const observerNames = observers;
                    const traces = taxaNames.map(taxa => ({ x: observerNames, y: observerNames.map(obs => data[taxa][obs] || 0), name: taxa, type: 'bar' }));
                    const layout = { barmode: 'stack', title: 'Observer Comparison by Taxa', xaxis: { title: 'Observer', automargin: true }, yaxis: { title: 'Number of Records' }, margin: { t: 50, b: 100, l: 60, r: 20 } };
                    Plotly.newPlot('observer-chart-container', traces, layout, plotlyConfig);
                }).fail(() => showErrorMessage('#observer-chart-container', 'Could not load Observer Comparison chart.'));
        }
    }
    function updateAnnualTrends() {
        const container = $('#annual-trends-container');
        container.append('<div class="loading-overlay"><span>Loading...</span></div>');

        return $.get(`${API_BASE_URL}/api/summary/annual_trends`).done(data => {
            if (!data.trends || data.trends.length === 0) {
                showErrorMessage('#annual-trends-container', 'No yearly data available to generate a trend analysis.');
                return;
            }
            annualData = data.trends;
            
            const tableBody = $('#annual-trends-table tbody').empty();
            annualData.forEach(yearData => {
                const row = `<tr>
                    <td><b>${yearData.year}</b></td>
                    <td>${yearData.total_records.toLocaleString()}</td>
                    <td>${yearData.unique_species.toLocaleString()}</td>
                    <td>${yearData.shannon}</td>
                    <td>${yearData.simpson}</td>
                </tr>`;
                tableBody.append(row);
            });
            
            drawAnnualChart();

        }).fail(() => {
            showErrorMessage('#annual-trends-container', 'Could not load annual trends.');
        }).always(() => {
            container.find('.loading-overlay').remove();
        });
    }
    function drawAnnualChart(event) {
        if (annualData.length === 0) return;

        if (event && $(event.currentTarget).is('button')) {
            $('#annual-trends-container .btn-group button').removeClass('active');
            $(event.currentTarget).addClass('active');
        }

        const chartDiv = 'annual-trends-chart';
        
        const selectedMetricKey = $('#annual-metric-select').val();
        const selectedMetricText = $('#annual-metric-select option:selected').text();
        const mode = $('#annual-standardized-btn').hasClass('active') ? 'standardized' : 'absolute';

        const years = annualData.map(d => d.year);
        const rawValues = annualData.map(d => d[selectedMetricKey]);
        
        let chartValues;
        let layout;

        if (mode === 'absolute') {
            chartValues = rawValues;
            layout = {
                title: { text: `<b>${selectedMetricText} per Year (Absolute)</b>`, font: { size: 18 } },
                yaxis: { title: 'Value' },
                xaxis: { type: 'category', title: 'Year' },
                margin: { t: 50, b: 40, l: 60, r: 20 }
            };
        } else { 
            const baseValue = rawValues[0];
            chartValues = baseValue > 0 ? rawValues.map(d => (d / baseValue) * 100) : rawValues.map(() => 0);
            
            layout = {
                title: { text: `<b>${selectedMetricText} Growth (First Year = 100)</b>`, font: { size: 18 } },
                yaxis: { title: 'Growth Index', ticksuffix: '%' },
                xaxis: { type: 'category', title: 'Year' },
                margin: { t: 50, b: 40, l: 60, r: 20 }
            };
        }

        const trace = [{ 
            x: years, 
            y: chartValues, 
            type: 'bar',
            hovertemplate: '<b>Year: %{x}</b><br>Value: %{y:.3f}<extra></extra>'
        }];

        Plotly.newPlot(chartDiv, trace, layout, plotlyConfig);
    }
    function loadUniqueSpeciesTable(page = 1) {
        const card = $('#unique-species-table').closest('.card');
        card.append('<div class="loading-overlay"><span>Loading...</span></div>');
        return $.get(`${API_BASE_URL}/api/all_unique_species`, { page: page, page_size: 10 }).done(data => {
            const tableBody = $('#unique-species-table tbody').empty();
            if (!data.species_list || data.species_list.length === 0) {
                tableBody.append('<tr><td style="text-align:center; padding: 2em;">No species found.</td></tr>');
            } else {
                data.species_list.forEach(speciesName => tableBody.append(`<tr><td><em>${speciesName}</em></td></tr>`));
            }
            updateUniqueSpeciesPagination(data.total_pages, data.page);
        }).fail(() => showErrorMessage('#unique-species-table tbody', 'Could not load the species list.'))
          .always(() => card.find('.loading-overlay').remove());
    }
    function updateUniqueSpeciesPagination(totalPages, page) {
        const container = $('#unique-species-pagination').empty();
        if (totalPages <= 1) return;

        const firstButton = $('<button>First</button>').on('click', () => loadUniqueSpeciesTable(1)).prop('disabled', page === 1);
        const prevButton = $('<button>« Previous</button>').on('click', () => loadUniqueSpeciesTable(page - 1)).prop('disabled', page === 1);
        const nextButton = $('<button>Next »</button>').on('click', () => loadUniqueSpeciesTable(page + 1)).prop('disabled', page === totalPages);
        const lastButton = $('<button>Last</button>').on('click', () => loadUniqueSpeciesTable(totalPages)).prop('disabled', page === totalPages);
        
        container.append(firstButton, prevButton, `<span> Page ${page} of ${totalPages} </span>`, nextButton, lastButton);
    }

    initializeDashboard();
});
</script>
</body>
</html>